{% extends 'base.html' %}
{% load static %}

{% block title %}{{ comunidade.nome }} - Comunidade{% endblock %}

{% block content %}

<div class="container-principal-comunidade-detalhe" style="background-color: #fff; max-width: 1400px; margin: auto;">

    <header class="comunidade-banner" style="position: relative; color: white;">
        {% if comunidade.imagem_banner %}
            <img src="{{ comunidade.imagem_banner.url }}" alt="Banner da Comunidade {{ comunidade.nome }}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 8px;">
        {% else %}
            <div style="width: 100%; height: 300px; background-color: #555; border-radius: 8px;"></div>
        {% endif %}
        
        <div class="banner-info" style="position: absolute; bottom: 20px; left: 20px; text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">
            <span style="background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; font-size: 0.9rem;">Comunidade Assinada</span>
            <h1 style="margin: 10px 0;">{{ comunidade.nome }}</h1>
            <p style="margin: 0;">
                Autor: <strong>{{ comunidade.criador.username }}</strong>
                &nbsp; | &nbsp; 
                Desde {{ comunidade.data_criacao|date:"d M Y" }}
                &nbsp; | &nbsp; 
                {{ comunidade.membros.count }} Membros
            </p>
        </div>
    </header>

    <main class="comunidade-layout-grid" style="display: grid; grid-template-columns: 250px 1fr 250px; gap: 2rem; padding: 2rem; background-color: #f0f2f5;">

        <aside class="coluna-esquerda">
            <div class="widget" style="background: #fff; border-radius: 8px; border: 1px solid #ddd; padding: 1rem; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0;">10 Destaques</h4>
                <ul style="list-style: none; padding: 0;">
                    {% for destaque in destaques %}
                        <li style="border-bottom: 1px solid #eee; padding: 0.5rem 0;">
                            <a href="#" style="text-decoration: none; color: #333; font-size: 0.9rem;">{{ destaque.conteudo|truncatechars:50 }}</a>
                            <span style="font-size: 0.8rem; color: #777; display: block;">por {{ destaque.autor.username }}</span>
                        </li>
                    {% empty %}
                        <li>N칚o h치 destaques no momento.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="widget" style="background: #fff; border-radius: 8px; border: 1px solid #ddd; padding: 1rem;">
                <h4 style="margin-top: 0;">10 Not칤cias/Servi칞os</h4>
                <ul style="list-style: none; padding: 0;">
                    {% for noticia in noticias_servicos %}
                        <li style="border-bottom: 1px solid #eee; padding: 0.5rem 0;">
                            <a href="{% url 'detalhe_noticia' slug=noticia.slug %}" style="text-decoration: none; color: #333; font-size: 0.9rem;">{{ noticia.titulo }}</a>
                        </li>
                    {% empty %}
                        <li>N칚o h치 not칤cias no momento.</li>
                    {% endfor %}
                </ul>
            </div>
        </aside>

        <section class="coluna-central">
            
            <form method="POST" class="form-publicacao" style="background: #fff; border-radius: 8px; border: 1px solid #ddd; padding: 1rem; margin-bottom: 1.5rem;">
                <h5 style="margin-top: 0;">Criar uma publica칞칚o</h5>
                {% csrf_token %}
                {{ form_publicacao.as_p }}
                <button type="submit" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Publicar
                </button>
            </form>

            {% for publicacao in feed_publicacoes %}
                <article class="card-publicacao" style="background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 1.5rem;">
                    
                    <div class="post-header" style="padding: 1rem; display: flex; align-items: center; border-bottom: 1px solid #eee;">
                        <div class="avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #ccc; margin-right: 10px;"></div>
                        <div>
                            <strong>{{ publicacao.autor.username }}</strong>
                            <span style="font-size: 0.9rem; color: #777;"> | {{ publicacao.data_publicacao|timesince }} atr치s</span>
                        </div>
                    </div>

                    <div class="post-conteudo" style="padding: 1rem;">
                        <p>{{ publicacao.conteudo|linebreaksbr }}</p>
                    </div>

                    <div class="post-footer" style="padding: 1rem; border-top: 1px solid #eee; display: flex; gap: 1.5rem; font-size: 0.9rem; color: #555;">
                        
                        <span class="like-wrapper">
                            {% if user.is_authenticated %}
                                <form action="{% url 'curtir_publicacao' pk=publicacao.pk %}" method="POST" class="form-like" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="like-button" style="background: none; border: none; padding: 0; cursor: pointer; font-size: 0.9rem; color: {% if user in publicacao.curtidas.all %}#007bff{% else %}#555{% endif %};">
                                        游녨 <span class="like-count">{{ publicacao.curtidas.count }}</span>
                                        <span class="like-text">{% if user in publicacao.curtidas.all %}Curtido{% else %}Curtir{% endif %}</span>
                                    </button>
                                </form>
                            {% else %}
                                <span>游녨 {{ publicacao.curtidas.count }} Curtidas</span>
                            {% endif %}
                        </span>

                        <span class="botao-focar-comentario" style="cursor: pointer;" title="Escrever um coment치rio">
                            游눫 <span class="comment-count-val">{{ publicacao.comentarios.count }}</span> Coment치rios
                        </span>

                        <span class="save-wrapper">
                            {% if user.is_authenticated %}
                                <form action="{% url 'salvar_publicacao' pk=publicacao.pk %}" method="POST" class="form-save" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="save-button" style="background: none; border: none; padding: 0; cursor: pointer; font-size: 0.9rem; color: {% if user in publicacao.salvo_por.all %}#007bff{% else %}#555{% endif %};">
                                        <span class="save-text">{% if user in publicacao.salvo_por.all %}游 Salvo{% else %}游 Salvar{% endif %}</span>
                                    </button>
                                </form>
                            {% else %}
                                <span>游 Salvar</span>
                            {% endif %}
                        </span>
                    </div>

                    <div class="comentarios-secao" style="padding: 0 1rem 1rem 1rem; border-top: 1px solid #eee;">

                        {% if user.is_authenticated %}
                            <form action="{% url 'adicionar_comentario' pk=publicacao.pk %}" method="POST" class="form-comentario" style="margin-top: 1rem;">
                                {% csrf_token %}
                                
                                <div class="form_campo">
                                    {{ form_comentario.conteudo }}
                                </div>
                                
                                <button type="submit" style="padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; font-size: 0.9rem;">
                                    Comentar
                                </button>
                            </form>
                        {% else %}
                            <p style="font-size: 0.9rem; color: #555; margin-top: 1rem;">
                                <a href="{% url 'login' %}">Fa칞a login</a> para comentar.
                            </p>
                        {% endif %}

                        <div class="lista-comentarios" style="margin-top: 1.5rem;">
                            {% for comentario in publicacao.comentarios.all %}
                                <div class="comentario-item" style="margin-bottom: 1rem; font-size: 0.9rem;">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <div class="avatar" style="width: 25px; height: 25px; border-radius: 50%; background: #ddd; margin-right: 8px;"></div>
                                        <strong>{{ comentario.autor.username }}</strong>
                                        <span style="color: #777; margin-left: 10px;">{{ comentario.data_publicacao|timesince }} atr치s</span>
                                    </div>
                                    <p style="margin: 0 0 0 33px; padding-left: 0;">{{ comentario.conteudo|linebreaksbr }}</p>
                                </div>
                            {% empty %}
                                {% if user.is_authenticated %}
                                    <p class="sem-comentarios-msg" style="font-size: 0.9rem; color: #777;">Seja o primeiro a comentar!</p>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </article>
            {% empty %}
                <div style="background: #fff; border-radius: 8px; border: 1px solid #ddd; padding: 1rem;">
                    <p>Esta comunidade ainda n칚o tem publica칞칫es. Seja o primeiro a postar!</p>
                </div>
            {% endfor %}

        </section>

        <aside class="coluna-direita">
            <div class="widget-vazio" style="background: #fff; border-radius: 8px; border: 1px solid #ddd; padding: 1rem; min-height: 200px;">
                <p>(Espa칞o Direita)</p>
            </div>
        </aside>
    </main>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // 1. CURTIR
    const likeForms = document.querySelectorAll('.form-like');
    likeForms.forEach(form => {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const url = form.action;
            const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(url, {
                method: 'POST',
                headers: {'X-CSRFToken': csrf, 'Accept': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const button = form.querySelector('.like-button');
                    const countSpan = form.querySelector('.like-count');
                    const textSpan = form.querySelector('.like-text');
                    countSpan.textContent = data.likes_count;
                    if (data.is_liked) {
                        textSpan.textContent = 'Curtido';
                        button.style.color = '#007bff';
                    } else {
                        textSpan.textContent = 'Curtir';
                        button.style.color = '#555';
                    }
                }
            })
            .catch(error => console.error('Erro:', error));
        });
    });

    // 2. SALVAR
    const saveForms = document.querySelectorAll('.form-save');
    saveForms.forEach(form => {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const url = form.action;
            const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(url, {
                method: 'POST',
                headers: {'X-CSRFToken': csrf, 'Accept': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const button = form.querySelector('.save-button');
                    const textSpan = form.querySelector('.save-text');
                    if (data.is_saved) {
                        textSpan.textContent = '游 Salvo';
                        button.style.color = '#007bff';
                        textSpan.style.fontWeight = 'bold'; 
                    } else {
                        textSpan.textContent = '游 Salvar';
                        button.style.color = '#555';
                        textSpan.style.fontWeight = 'normal';
                    }
                }
            })
            .catch(error => console.error('Erro:', error));
        });
    });

    // 3. COMENTAR (AJAX)
    const commentForms = document.querySelectorAll('.form-comentario');
    commentForms.forEach(form => {
        form.addEventListener('submit', (event) => {
            // 칄 ESTA LINHA QUE IMPEDE A TELA PRETA
            event.preventDefault();
            
            const url = form.action;
            const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;
            const formData = new FormData(form);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrf,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const section = form.closest('.comentarios-secao');
                    const list = section.querySelector('.lista-comentarios');
                    const emptyMsg = list.querySelector('.sem-comentarios-msg');
                    
                    if (emptyMsg) {
                        emptyMsg.remove();
                    }

                    const newCommentHTML = `
                        <div class="comentario-item" style="margin-bottom: 1rem; font-size: 0.9rem; animation: fadeIn 0.5s;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div class="avatar" style="width: 25px; height: 25px; border-radius: 50%; background: #ddd; margin-right: 8px;"></div>
                                <strong>${data.autor}</strong>
                                <span style="color: #777; margin-left: 10px;">agora mesmo</span>
                            </div>
                            <p style="margin: 0 0 0 33px; padding-left: 0;">${data.conteudo.replace(/\n/g, "<br>")}</p>
                        </div>
                    `;

                    list.insertAdjacentHTML('beforeend', newCommentHTML);
                    form.reset();

                    const article = form.closest('article');
                    const countSpan = article.querySelector('.comment-count-val');
                    if (countSpan) {
                        countSpan.textContent = data.comments_count;
                    }
                }
            })
            .catch(error => console.error('Erro ao comentar:', error));
        });
    });

    // 4. CLIQUE NO BAL츾O DE COMENT츼RIO (NOVO!)
    const commentButtons = document.querySelectorAll('.botao-focar-comentario');
    
    commentButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            // Encontra o formul치rio de coment치rio dentro do MESMO card (article)
            const article = btn.closest('article');
            const input = article.querySelector('.form-comentario textarea, .form-comentario input[type=text]');
            
            if (input) {
                input.focus(); // Coloca o cursor na caixa de texto
            }
        });
    });

});
</script>

{% endblock %}